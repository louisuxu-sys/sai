<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ°ç¥è³½ç‰¹å°ˆå±¬æ•¸æ“šåˆ†æ - æˆ¿é–“ 1~3000</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }

    /* ===== ç™»å…¥é®ç½©æ¨£å¼ ===== */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000000; z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    #loginOverlay.hidden { display: none; }
    .login-box {
      background: #111827; border: 1px solid rgba(34,211,238,0.3);
      border-radius: 16px; padding: 40px 32px; width: 100%; max-width: 400px; margin: 0 16px;
      box-shadow: 0 0 40px rgba(34,211,238,0.1);
    }

    /* ===== ç™»å…¥é€²åº¦æ¢æ¨£å¼ ===== */
    .login-progress-container {
      display: none;
      text-align: center;
      padding: 40px 32px;
      width: 100%; max-width: 440px; margin: 0 16px;
    }
    .login-progress-title {
      font-size: 22px; font-weight: 900; color: #fff;
      margin-bottom: 8px; letter-spacing: 2px;
    }
    .login-progress-subtitle {
      font-size: 13px; color: #22d3ee; letter-spacing: 3px;
      margin-bottom: 6px; text-shadow: 0 0 10px #22d3ee;
    }
    .login-progress-user {
      font-size: 15px; color: #a5b4fc; margin-bottom: 24px;
      font-family: Consolas, monospace; letter-spacing: 1px;
    }
    .login-progress-status {
      font-size: 16px; font-weight: 700; color: #22d3ee;
      letter-spacing: 6px; margin-bottom: 20px;
      text-shadow: 0 0 15px #22d3ee, 0 0 30px rgba(34,211,238,0.4);
      opacity: 0; transition: opacity 0.5s ease;
    }
    .login-progress-status.visible { opacity: 1; }
    .login-progress-bar-outer {
      width: 100%; height: 6px; background: #1e293b;
      border-radius: 3px; overflow: hidden; margin-bottom: 14px;
      border: 1px solid rgba(34,211,238,0.2);
    }
    .login-progress-bar-inner {
      height: 100%; width: 0%; border-radius: 3px;
      background: linear-gradient(90deg, #06b6d4, #3b82f6, #22d3ee);
      box-shadow: 0 0 12px rgba(34,211,238,0.6);
      transition: width 0.3s ease;
    }
    .login-progress-percent {
      font-size: 12px; color: #64748b; font-family: Consolas, monospace;
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .login-progress-container.active {
      display: block;
      animation: fadeInScale 0.4s ease forwards;
    }
    .login-box h2 { text-align: center; font-size: 24px; font-weight: 900; color: #fff; margin-bottom: 6px; }
    .login-box .sub { text-align: center; font-size: 12px; color: #22d3ee; letter-spacing: 3px; margin-bottom: 28px;
      text-shadow: 0 0 10px #22d3ee; }
    .login-box label { display: block; color: #9ca3af; font-size: 14px; font-weight: 700; margin-bottom: 6px; }
    .login-box input {
      width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(75,85,99,0.5);
      color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 15px; margin-bottom: 18px;
      outline: none; transition: all 0.3s;
    }
    .login-box input:focus { border-color: #22d3ee; box-shadow: 0 0 12px rgba(34,211,238,0.3); }
    .login-box .login-btn {
      width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 17px; font-weight: 700;
      color: #fff; cursor: pointer; background: linear-gradient(135deg, #06b6d4, #3b82f6);
      transition: all 0.3s;
    }
    .login-box .login-btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(34,211,238,0.5); }
    .login-box .error { color: #f87171; font-size: 13px; text-align: center; margin-bottom: 10px; display: none; }
    .login-box .lock-icon { text-align: center; margin-bottom: 20px; }
    .login-box .lock-icon svg { width: 48px; height: 48px; margin: 0 auto; }
    .login-box .footer-text { text-align: center; color: #4b5563; font-size: 11px; margin-top: 18px; }

    /* ===== è‡ªå‹•åˆ·æ–°å€’æ•¸è¨ˆæ™‚ ===== */
    #autoRefreshBar {
      position: fixed; top: 0; left: 0; height: 4px; z-index: 100;
      background: linear-gradient(90deg, #06b6d4, #3b82f6, #8b5cf6);
      transition: width 1s linear;
      box-shadow: 0 0 10px rgba(34,211,238,0.5);
    }
    /* å€’æ•¸è¨ˆæ™‚å™¨æµ®å‹•é¡¯ç¤º */
    #refreshCountdown {
      position: fixed; top: 10px; right: 16px; z-index: 101;
      background: rgba(17,24,39,0.9); border: 1px solid rgba(34,211,238,0.4);
      border-radius: 10px; padding: 8px 16px; font-size: 13px;
      color: #22d3ee; display: flex; align-items: center; gap: 8px;
      backdrop-filter: blur(8px); box-shadow: 0 0 20px rgba(34,211,238,0.15);
      transition: all 0.3s ease;
    }
    #refreshCountdown .timer-icon { animation: spin 4s linear infinite; display: inline-block; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    /* æ›´æ–°é€šçŸ¥ */
    #refreshNotify {
      position: fixed; top: 60px; right: 16px; z-index: 101;
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      border-radius: 10px; padding: 10px 20px; font-size: 14px; font-weight: 700;
      color: #fff; opacity: 0; transform: translateX(40px);
      transition: all 0.4s ease; pointer-events: none;
      box-shadow: 0 4px 20px rgba(34,211,238,0.4);
    }
    #refreshNotify.show { opacity: 1; transform: translateX(0); }
    .glow-cyan { text-shadow: 0 0 10px #22d3ee, 0 0 20px #22d3ee; }
    .card-hover:hover { transform: scale(1.05); }
    .bar-glow { box-shadow: 0 0 10px #22d3ee; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #22d3ee; border-radius: 4px; }

    /* æœå°‹æ¡†æ¨£å¼ */
    #searchInput:focus { box-shadow: 0 0 15px rgba(34, 211, 238, 0.5); }
    
    /* åˆ†é æŒ‰éˆ•å‹•ç•« */
    .page-btn { transition: all 0.2s ease; }
    .page-btn:hover { transform: translateY(-2px); }
    .page-btn.active { 
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
    }

    /* è¼‰å…¥å‹•ç•« */
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .loading-pulse { animation: pulse-glow 1.5s infinite; }

    /* å¡ç‰‡æ·¡å…¥ */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card-animate { animation: fadeInUp 0.4s ease forwards; }

    /* ===== ç™»å‡ºæŒ‰éˆ• ===== */
    #logoutBtn {
      position: fixed; top: 10px; left: 16px; z-index: 101;
      background: rgba(17,24,39,0.9); border: 1px solid rgba(248,113,113,0.4);
      border-radius: 10px; padding: 8px 18px; font-size: 13px; font-weight: 700;
      color: #f87171; cursor: pointer; display: none;
      backdrop-filter: blur(8px); box-shadow: 0 0 20px rgba(248,113,113,0.15);
      transition: all 0.3s ease;
    }
    #logoutBtn:hover {
      background: rgba(248,113,113,0.2); border-color: #f87171;
      box-shadow: 0 0 20px rgba(248,113,113,0.4); transform: translateY(-1px);
    }
  </style>
</head>
<body class="min-h-screen bg-black text-white">

  <!-- ===== ç™»å…¥é®ç½© ===== -->
  <div id="loginOverlay">
    <!-- ç™»å…¥è¡¨å–® -->
    <div class="login-box" id="loginBox">
      <div class="lock-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </div>
      <h2>ç³»çµ±ç™»å…¥</h2>
      <div class="sub">AUTHORIZED ACCESS ONLY</div>

      <label>æˆæ¬Šåºè™Ÿ</label>
      <input type="text" id="serialInput" placeholder="è«‹è¼¸å…¥åºè™Ÿ (ä¾‹: XXXX-XXXX-XXXX)" style="text-transform:uppercase; font-family:Consolas,monospace; letter-spacing:2px;">
      <p class="error" id="serialError">âš  åºè™Ÿç„¡æ•ˆæˆ–æ ¼å¼éŒ¯èª¤</p>
      <button type="button" class="login-btn" onclick="handleSerialLogin()">åºè™Ÿé©—è­‰ç™»å…¥</button>
      <div class="footer-text" style="margin-top:12px;">è«‹å‘ç®¡ç†å“¡ç´¢å–æˆæ¬Šåºè™Ÿ</div>

      <div class="footer-text">ğŸ”’ æ­¤ç³»çµ±åƒ…é™æˆæ¬Šäººå“¡ä½¿ç”¨</div>
    </div>

    <!-- ç™»å…¥é€²åº¦æ¢ï¼ˆé©—è­‰æˆåŠŸå¾Œé¡¯ç¤ºï¼‰ -->
    <div class="login-progress-container" id="loginProgress">
      <div class="login-progress-title">æˆ°ç¥è³½ç‰¹å°ˆå±¬æ•¸æ“šåˆ†æ</div>
      <div class="login-progress-subtitle">AUTHORIZED ACCESS</div>
      <div class="login-progress-user" id="loginProgressUser"></div>
      <div class="login-progress-status" id="loginProgressStatus">ACCESS GRANTED</div>
      <div class="login-progress-bar-outer">
        <div class="login-progress-bar-inner" id="loginProgressBar"></div>
      </div>
      <div class="login-progress-percent" id="loginProgressPercent">0%</div>
    </div>
  </div>

  <!-- ===== ç™»å‡ºæŒ‰éˆ• ===== -->
  <button id="logoutBtn" onclick="handleLogout()" title="ç™»å‡ºç³»çµ±">ğŸšª ç™»å‡º</button>

  <!-- è‡ªå‹•åˆ·æ–°é€²åº¦æ¢ -->
  <div id="autoRefreshBar" style="width:0%"></div>

  <!-- å€’æ•¸è¨ˆæ™‚å™¨ -->
  <div id="refreshCountdown" style="display:none;">
    <span class="timer-icon">âš™ï¸</span>
    <span>ä¸‹æ¬¡æ›´æ–°ï¼š<strong id="countdownText">5:00</strong></span>
  </div>

  <!-- æ›´æ–°é€šçŸ¥ -->
  <div id="refreshNotify">âœ… çˆ†åˆ†ç‡æ•¸æ“šå·²è‡ªå‹•æ›´æ–°ï¼</div>

  <!-- é ‚éƒ¨æ¨™é¡Œ -->
  <header class="pt-10 pb-6 text-center">
    <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 mb-2">
      æˆ°ç¥è³½ç‰¹å°ˆå±¬æ•¸æ“šåˆ†æ
    </h1>
    <p class="text-cyan-500 text-sm tracking-[0.2em] glow-cyan">REAL-TIME SIGNAL MONITORING</p>
    <p class="text-gray-500 text-xs mt-2">æˆ¿é–“ç¸½æ•¸ï¼š3000 | æ•¸æ“šå³æ™‚æ›´æ–°</p>
  </header>

  <!-- æœå°‹èˆ‡ç¯©é¸ -->
  <div class="max-w-6xl mx-auto px-4 mb-6">
    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
      <!-- æœå°‹ -->
      <div class="flex items-center gap-3 w-full md:w-auto">
        <input 
          id="searchInput" 
          type="text" 
          placeholder="ğŸ” æœå°‹æˆ¿è™Ÿ (1-3000)..." 
          class="bg-gray-900 border border-gray-700 text-white px-4 py-2 rounded-lg w-full md:w-64 focus:border-cyan-500 outline-none transition-all"
        >
        <button 
          onclick="searchRoom()" 
          class="bg-cyan-600 hover:bg-cyan-500 text-black font-bold px-5 py-2 rounded-lg transition-all whitespace-nowrap"
        >
          æœå°‹
        </button>
      </div>
      <!-- ç¯©é¸ -->
      <div class="flex items-center gap-3">
        <label class="text-gray-400 text-sm">çˆ†åˆ†ç‡ç¯©é¸ï¼š</label>
        <select id="filterRate" onchange="applyFilter()" class="bg-gray-900 border border-gray-700 text-white px-3 py-2 rounded-lg outline-none">
          <option value="all">å…¨éƒ¨</option>
          <option value="80">â‰¥ 80%</option>
          <option value="60">â‰¥ 60%</option>
          <option value="40">â‰¥ 40%</option>
          <option value="20">â‰¥ 20%</option>
        </select>
        <button 
          onclick="refreshAllData(true)" 
          class="bg-transparent border border-cyan-500 text-cyan-500 px-5 py-2 rounded-lg hover:bg-cyan-500 hover:text-black transition-all font-bold"
        >
          ğŸ”„ æ›´æ–°æ•¸æ“š
        </button>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="max-w-6xl mx-auto px-4 mb-6">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
        <p class="text-gray-500 text-xs mb-1">é«˜çˆ†åˆ†æˆ¿é–“ (â‰¥80%)</p>
        <p id="statHigh" class="text-green-400 text-2xl font-black">--</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
        <p class="text-gray-500 text-xs mb-1">ä¸­çˆ†åˆ†æˆ¿é–“ (50-79%)</p>
        <p id="statMid" class="text-yellow-400 text-2xl font-black">--</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
        <p class="text-gray-500 text-xs mb-1">ä½çˆ†åˆ†æˆ¿é–“ (<50%)</p>
        <p id="statLow" class="text-red-400 text-2xl font-black">--</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 text-center">
        <p class="text-gray-500 text-xs mb-1">å¹³å‡çˆ†åˆ†ç‡</p>
        <p id="statAvg" class="text-cyan-400 text-2xl font-black">--</p>
      </div>
    </div>
  </div>

  <!-- æˆ¿é–“å¡ç‰‡ç¶²æ ¼ -->
  <div class="max-w-6xl mx-auto px-4">
    <div id="roomGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </div>
  </div>

  <!-- åˆ†é  -->
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex flex-col items-center gap-4">
      <div id="pagination" class="flex flex-wrap justify-center gap-2">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
      </div>
      <p id="pageInfo" class="text-gray-500 text-sm"></p>
    </div>
  </div>

  <!-- åº•éƒ¨ -->
  <footer class="text-center py-8 border-t border-gray-900">
    <p class="text-gray-600 text-xs">æˆ°ç¥è³½ç‰¹æ•¸æ“šåˆ†æç³»çµ± Â© 2026 | æ•¸æ“šåƒ…ä¾›åƒè€ƒ</p>
  </footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
// ============ Firebase åˆå§‹åŒ– ============
var firebaseConfig = {
  apiKey: "AIzaSyBPQ9m9uDsInFJiYpadA5LcZhQug6ob5no",
  authDomain: "sai-bot-e36e8.firebaseapp.com",
  databaseURL: "https://sai-bot-e36e8-default-rtdb.firebaseio.com",
  projectId: "sai-bot-e36e8",
  storageBucket: "sai-bot-e36e8.firebasestorage.app",
  messagingSenderId: "464722073392",
  appId: "1:464722073392:web:726915bcee927b588e1af5",
  measurementId: "G-THDYRX6EGX"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();
var serialsRef = db.ref('serials');

// ============ é…ç½® ============
const TOTAL_ROOMS = 3000;
const ROOMS_PER_PAGE = 500;
const TOTAL_PAGES = Math.ceil(TOTAL_ROOMS / ROOMS_PER_PAGE);

// è¨Šè™Ÿå…ƒç´ 
const SIGNAL_NAMES = ['ç”²èŸ²', 'çœ¼', 'è›‡', 'å¼“', 'åˆ€'];
const COLORS = [
  { border: 'border-cyan-500', shadow: 'shadow-cyan-500/50', gradient: 'from-cyan-400 to-blue-500' },
  { border: 'border-purple-500', shadow: 'shadow-purple-500/50', gradient: 'from-purple-400 to-pink-500' },
  { border: 'border-pink-500', shadow: 'shadow-pink-500/50', gradient: 'from-pink-400 to-red-500' },
  { border: 'border-blue-500', shadow: 'shadow-blue-500/50', gradient: 'from-blue-400 to-indigo-500' },
  { border: 'border-green-500', shadow: 'shadow-green-500/50', gradient: 'from-green-400 to-emerald-500' },
  { border: 'border-yellow-500', shadow: 'shadow-yellow-500/50', gradient: 'from-yellow-400 to-orange-500' },
  { border: 'border-red-500', shadow: 'shadow-red-500/50', gradient: 'from-red-400 to-rose-500' },
  { border: 'border-indigo-500', shadow: 'shadow-indigo-500/50', gradient: 'from-indigo-400 to-violet-500' },
];

// ============ éš¨æ©Ÿæ•¸æ“šç”Ÿæˆ ============
// ä½¿ç”¨ seed ä¾†ç¢ºä¿æ¯å€‹æˆ¿é–“çš„æ•¸æ“šåœ¨åˆ·æ–°å‰æ˜¯ä¸€è‡´çš„
let dataSeed = Date.now();

function seededRandom(seed) {
  let x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

// ============ å…¨éƒ¨æˆ¿é–“æ•¸æ“š ============
let allRooms = [];
let filteredRooms = [];

function generateAllRooms() {
  allRooms = [];
  const comboUsageCount = {};    // è¨˜éŒ„æ¯ç¨®è¨Šè™Ÿçµ„åˆè¢«ä½¿ç”¨çš„æ¬¡æ•¸
  const MAX_ROOMS_PER_COMBO = 4; // åŒä¸€è¨Šè™Ÿçµ„åˆæœ€å¤šå‡ºç¾åœ¨å¹¾å€‹æˆ¿é–“

  for (let i = 1; i <= TOTAL_ROOMS; i++) {
    const baseSeed = dataSeed + i;
    const rate = Math.floor(seededRandom(baseSeed) * 100) + 1;

    // æ¯çµ„è¨Šè™Ÿ 3 æˆ– 4 å€‹ï¼ˆä¸å†å‡ºç¾ 5 å€‹ï¼‰
    const signalCount = 3 + Math.floor(seededRandom(baseSeed + 1) * 2); // 3 æˆ– 4

    let combo, comboKey;
    let attempts = 0;

    do {
      const aSeed = baseSeed + attempts * 97;

      // Fisher-Yates æ´—ç‰Œï¼šç¢ºä¿æ¯å€‹è¨Šè™Ÿé¡å‹ä¸é‡è¤‡
      let indices = [0, 1, 2, 3, 4]; // ç”²èŸ²=0, çœ¼=1, è›‡=2, å¼“=3, åˆ€=4
      for (let j = indices.length - 1; j > 0; j--) {
        const k = Math.floor(seededRandom(aSeed + j * 3) * (j + 1));
        [indices[j], indices[k]] = [indices[k], indices[j]];
      }
      // åªå–å‰ signalCount å€‹ï¼ˆä¿è­‰ä¸é‡è¤‡ï¼‰
      indices = indices.slice(0, signalCount);

      // ç‚ºæ¯å€‹è¨Šè™Ÿåˆ†é…æ•¸å­— 1~6
      combo = indices.map((sigIdx, pos) => {
        const num = Math.floor(seededRandom(aSeed + 20 + pos) * 6) + 1;
        return num + SIGNAL_NAMES[sigIdx];
      });

      // ç”¨æ’åºå¾Œçš„çµ„åˆä½œç‚º keyï¼ˆå¿½ç•¥é †åºä¾†åˆ¤æ–·æ˜¯å¦é‡è¤‡ï¼‰
      comboKey = [...combo].sort().join('|');
      attempts++;
    } while (comboUsageCount[comboKey] >= MAX_ROOMS_PER_COMBO && attempts < 50);

    // è¨˜éŒ„æ­¤çµ„åˆçš„ä½¿ç”¨æ¬¡æ•¸
    comboUsageCount[comboKey] = (comboUsageCount[comboKey] || 0) + 1;

    const colorIdx = Math.floor(seededRandom(baseSeed + 100) * COLORS.length);

    allRooms.push({
      id: i,
      displayId: String(i).padStart(4, '0'),
      rate: rate,
      signals: combo.join(' '),
      color: COLORS[colorIdx]
    });
  }

  filteredRooms = [...allRooms];
}

// ============ çµ±è¨ˆ ============
function updateStats() {
  const data = filteredRooms;
  const high = data.filter(r => r.rate >= 80).length;
  const mid = data.filter(r => r.rate >= 50 && r.rate < 80).length;
  const low = data.filter(r => r.rate < 50).length;
  const avg = data.length > 0 ? (data.reduce((s, r) => s + r.rate, 0) / data.length).toFixed(1) : 0;

  document.getElementById('statHigh').textContent = high;
  document.getElementById('statMid').textContent = mid;
  document.getElementById('statLow').textContent = low;
  document.getElementById('statAvg').textContent = avg + '%';
}

// ============ æ¸²æŸ“å¡ç‰‡ ============
function renderCards(page) {
  const grid = document.getElementById('roomGrid');
  grid.innerHTML = '';

  const start = (page - 1) * ROOMS_PER_PAGE;
  const end = Math.min(start + ROOMS_PER_PAGE, filteredRooms.length);
  const pageRooms = filteredRooms.slice(start, end);

  if (pageRooms.length === 0) {
    grid.innerHTML = `
      <div class="col-span-full text-center py-20">
        <p class="text-gray-500 text-lg">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æˆ¿é–“</p>
      </div>
    `;
    return;
  }

  pageRooms.forEach((room, idx) => {
    const rateColor = room.rate >= 80 ? 'text-green-400' : room.rate >= 50 ? 'text-yellow-400' : 'text-red-400';
    const barColor = room.rate >= 80 
      ? 'bg-gradient-to-r from-green-400 to-emerald-500' 
      : room.rate >= 50 
        ? 'bg-gradient-to-r from-yellow-400 to-orange-500' 
        : 'bg-gradient-to-r from-red-400 to-rose-500';

    // é‚Šæ¡†é¡è‰²ä¾ç…§çˆ†åˆ†ç‡å°æ‡‰
    const borderColor = room.rate >= 80 
      ? 'border-green-500' 
      : room.rate >= 50 
        ? 'border-yellow-500' 
        : 'border-red-500';
    const shadowColor = room.rate >= 80 
      ? 'shadow-green-500/50' 
      : room.rate >= 50 
        ? 'shadow-yellow-500/50' 
        : 'shadow-red-500/50';

    const card = document.createElement('div');
    card.className = `bg-gray-900 border-2 ${borderColor} ${shadowColor} shadow-lg rounded-xl p-5 card-hover transition-transform duration-300 card-animate`;
    card.style.animationDelay = `${idx * 0.03}s`;
    card.style.opacity = '0';

    card.innerHTML = `
      <div class="flex justify-between items-start mb-4">
        <div>
          <p class="text-gray-400 text-xs font-bold mb-1">æ¨è–¦æˆ¿è™Ÿ</p>
          <h3 class="text-white text-3xl font-black tracking-wider">${room.displayId}</h3>
        </div>
        <div class="text-right">
          <p class="text-gray-400 text-xs font-bold mb-1">é æ¸¬çˆ†åˆ†ç‡</p>
          <span class="${rateColor} text-2xl font-bold">${room.rate}%</span>
        </div>
      </div>
      <div class="w-full bg-gray-800 rounded-full h-2 mb-4">
        <div class="${barColor} h-2 rounded-full bar-glow" style="width: ${room.rate}%; transition: width 1s ease;"></div>
      </div>
      <div class="pt-3 border-t border-gray-800">
        <p class="text-gray-400 text-xs mb-1 font-bold">ç›®å‰è¨Šè™Ÿçµ„åˆï¼š</p>
        <p class="text-white text-sm tracking-widest">${room.signals}</p>
      </div>
    `;

    grid.appendChild(card);
  });

  // æ›´æ–°é é¢è³‡è¨Š
  document.getElementById('pageInfo').textContent = 
    `é¡¯ç¤ºç¬¬ ${start + 1} - ${end} é–“æˆ¿é–“ï¼Œå…± ${filteredRooms.length} é–“`;
}

// ============ åˆ†é  ============
let currentPage = 1;

function renderPagination() {
  const totalPages = Math.ceil(filteredRooms.length / ROOMS_PER_PAGE);
  const pag = document.getElementById('pagination');
  pag.innerHTML = '';

  // ä¸Šä¸€é 
  const prevBtn = createPageBtn('Â« ä¸Šä¸€é ', () => goToPage(currentPage - 1), currentPage === 1);
  pag.appendChild(prevBtn);

  // é ç¢¼é‚è¼¯ï¼šé¡¯ç¤ºé¦–é ã€æœ«é å’Œç•¶å‰é é™„è¿‘çš„é ç¢¼
  const pages = getPageNumbers(currentPage, totalPages);
  pages.forEach(p => {
    if (p === '...') {
      const dots = document.createElement('span');
      dots.className = 'text-gray-500 px-2 py-2 self-end';
      dots.textContent = '...';
      pag.appendChild(dots);
    } else {
      const btn = createPageBtn(p, () => goToPage(p), false, p === currentPage);
      pag.appendChild(btn);
    }
  });

  // ä¸‹ä¸€é 
  const nextBtn = createPageBtn('ä¸‹ä¸€é  Â»', () => goToPage(currentPage + 1), currentPage === totalPages);
  pag.appendChild(nextBtn);
}

function createPageBtn(text, onClick, disabled, active) {
  const btn = document.createElement('button');
  btn.textContent = text;
  btn.onclick = onClick;
  btn.disabled = disabled;
  btn.className = `page-btn px-3 py-2 rounded-lg text-sm font-bold transition-all ${
    active 
      ? 'active text-white' 
      : disabled 
        ? 'bg-gray-900 text-gray-700 cursor-not-allowed' 
        : 'bg-gray-900 text-gray-300 border border-gray-700 hover:border-cyan-500 hover:text-cyan-400'
  }`;
  return btn;
}

function getPageNumbers(current, total) {
  if (total <= 10) return Array.from({ length: total }, (_, i) => i + 1);
  
  const pages = [];
  pages.push(1);
  
  if (current > 4) pages.push('...');
  
  const start = Math.max(2, current - 2);
  const end = Math.min(total - 1, current + 2);
  
  for (let i = start; i <= end; i++) pages.push(i);
  
  if (current < total - 3) pages.push('...');
  
  pages.push(total);
  return pages;
}

function goToPage(page) {
  const totalPages = Math.ceil(filteredRooms.length / ROOMS_PER_PAGE);
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  renderCards(currentPage);
  renderPagination();
  window.scrollTo({ top: 300, behavior: 'smooth' });
}

// ============ æœå°‹ ============
function searchRoom() {
  const input = document.getElementById('searchInput').value.trim();
  if (!input) {
    applyFilter();
    return;
  }

  const num = parseInt(input);
  if (isNaN(num) || num < 1 || num > TOTAL_ROOMS) {
    alert('è«‹è¼¸å…¥ 1 åˆ° 3000 ä¹‹é–“çš„æˆ¿è™Ÿï¼');
    return;
  }

  // æ‰¾åˆ°è©²æˆ¿é–“
  filteredRooms = allRooms.filter(r => r.id === num);
  currentPage = 1;
  renderCards(currentPage);
  renderPagination();
  updateStats();
}

// Enter éµæœå°‹
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchRoom();
  });
});

// ============ ç¯©é¸ ============
function applyFilter() {
  const filterVal = document.getElementById('filterRate').value;
  const searchVal = document.getElementById('searchInput').value.trim();

  if (searchVal) {
    const num = parseInt(searchVal);
    if (!isNaN(num) && num >= 1 && num <= TOTAL_ROOMS) {
      filteredRooms = allRooms.filter(r => r.id === num);
    }
  } else if (filterVal === 'all') {
    filteredRooms = [...allRooms];
  } else {
    const minRate = parseInt(filterVal);
    filteredRooms = allRooms.filter(r => r.rate >= minRate);
  }

  currentPage = 1;
  renderCards(currentPage);
  renderPagination();
  updateStats();
}

// ============ æ›´æ–°æ•¸æ“š ============
function refreshAllData(isManual) {
  dataSeed = Date.now();
  document.getElementById('searchInput').value = '';
  document.getElementById('filterRate').value = 'all';
  generateAllRooms();
  currentPage = 1;
  updateStats();
  renderCards(currentPage);
  renderPagination();
  // æ‰‹å‹•é»æ“Šæ™‚ä¹Ÿé‡ç½®è‡ªå‹•å€’æ•¸
  if (isManual) {
    resetAutoRefreshTimer();
    showRefreshNotify();
  }
}

// ============ åºè™Ÿç³»çµ± ============
var SERIAL_SECRET = 'SAIT2026XKEY';
var SERIAL_CHARS = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';

function computeCheck(body) {
  var hash = 0;
  var str = body + SERIAL_SECRET;
  for (var i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  var result = '';
  var h = Math.abs(hash);
  for (var i = 0; i < 4; i++) {
    result += SERIAL_CHARS[h % SERIAL_CHARS.length];
    h = Math.floor(h / SERIAL_CHARS.length);
  }
  return result;
}

function validateSerial(serial) {
  var clean = serial.replace(/-/g, '').toUpperCase().trim();
  if (clean.length !== 12) return false;
  var random = clean.substring(0, 8);
  var check = clean.substring(8, 12);
  return computeCheck(random) === check;
}

// ============ åºè™Ÿç™»å…¥ï¼ˆFirebase é›²ç«¯ç‰ˆï¼‰============
function findSerialInFirebase(serial, callback) {
  var clean = serial.replace(/-/g, '').toUpperCase().trim();
  serialsRef.once('value').then(function(snapshot) {
    var data = snapshot.val();
    var list = data ? data : [];
    for (var i = 0; i < list.length; i++) {
      if (!list[i] || !list[i].code) continue;
      var itemClean = list[i].code.replace(/-/g, '').toUpperCase().trim();
      if (itemClean === clean) {
        callback(list[i]);
        return;
      }
    }
    callback(null);
  }).catch(function(err) {
    console.error('Firebase è®€å–å¤±æ•—:', err);
    callback(null);
  });
}

function showLoginError(errorEl, message) {
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  var box = document.querySelector('.login-box');
  box.style.borderColor = 'rgba(248,113,113,0.5)';
  setTimeout(function(){ box.style.borderColor = 'rgba(34,211,238,0.3)'; }, 600);
}

function startLoginAnimation(serial) {
  localStorage.setItem('rooms_serial', serial);
  sessionStorage.setItem('rooms_loggedIn', 'true');
  document.getElementById('serialError').style.display = 'none';

  // éš±è—ç™»å…¥è¡¨å–®ï¼Œé¡¯ç¤ºé€²åº¦æ¢
  document.getElementById('loginBox').style.display = 'none';
  var progressContainer = document.getElementById('loginProgress');
  var progressBar = document.getElementById('loginProgressBar');
  var progressPercent = document.getElementById('loginProgressPercent');
  var progressStatus = document.getElementById('loginProgressStatus');
  var progressUser = document.getElementById('loginProgressUser');

  // é¡¯ç¤ºåºè™Ÿï¼ˆéƒ¨åˆ†é®è”½ï¼‰
  var displaySerial = serial.length > 8 ? serial.substring(0, 4) + '****' + serial.substring(serial.length - 4) : serial;
  progressUser.textContent = displaySerial;

  progressContainer.classList.add('active');

  // 0.5ç§’å¾Œé¡¯ç¤º ACCESS GRANTED
  setTimeout(function() {
    progressStatus.classList.add('visible');
  }, 500);

  // é€²åº¦æ¢å‹•ç•«
  var loginProgress = 0;
  var loginProgressTimer = setInterval(function() {
    var increment = Math.random() * 8 + 2;
    loginProgress += increment;
    if (loginProgress >= 100) {
      loginProgress = 100;
      clearInterval(loginProgressTimer);
      progressBar.style.width = '100%';
      progressPercent.textContent = '100%';

      setTimeout(function() {
        document.getElementById('loginOverlay').classList.add('hidden');
        progressContainer.classList.remove('active');
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressStatus.classList.remove('visible');
        document.getElementById('loginBox').style.display = '';
        document.getElementById('logoutBtn').style.display = 'block';
        startAutoRefresh();
      }, 600);
    } else {
      progressBar.style.width = Math.floor(loginProgress) + '%';
      progressPercent.textContent = Math.floor(loginProgress) + '%';
    }
  }, 80);
}

function handleSerialLogin() {
  var serial = document.getElementById('serialInput').value.trim().toUpperCase();
  var errorEl = document.getElementById('serialError');

  // å…ˆé©—è­‰åºè™Ÿæ ¼å¼
  if (!validateSerial(serial)) {
    showLoginError(errorEl, 'âš  åºè™Ÿç„¡æ•ˆæˆ–æ ¼å¼éŒ¯èª¤');
    return;
  }

  // ç¦ç”¨æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
  var loginBtn = document.querySelector('.login-btn');
  loginBtn.textContent = 'ğŸ”„ é©—è­‰ä¸­...';
  loginBtn.disabled = true;
  loginBtn.style.opacity = '0.6';

  var now = Date.now();

  // 1. å¾ Firebase é›²ç«¯æŸ¥æ‰¾åºè™Ÿ
  findSerialInFirebase(serial, function(storedItem) {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    loginBtn.textContent = 'åºè™Ÿé©—è­‰ç™»å…¥';
    loginBtn.disabled = false;
    loginBtn.style.opacity = '1';

    if (storedItem) {
      // åºè™Ÿå­˜åœ¨æ–¼é›²ç«¯è³‡æ–™åº« â†’ æª¢æŸ¥æ˜¯å¦éæœŸ
      if (storedItem.expiresAt && now > storedItem.expiresAt) {
        showLoginError(errorEl, 'âš  æ­¤åºè™Ÿå·²éæœŸï¼ï¼ˆæœ‰æ•ˆæœŸï¼š' + (storedItem.durationLabel || 'æœªçŸ¥') + 'ï¼‰');
        removeUserSerialRecord(serial);
        return;
      }
      // æœªéæœŸ â†’ å„²å­˜åˆ°ç”¨æˆ¶æœ¬åœ°ç´€éŒ„ï¼ˆå‚™ä»½æœ‰æ•ˆæœŸè³‡è¨Šï¼‰
      saveUserSerialRecord(serial, storedItem.expiresAt, storedItem.durationLabel);
      // é©—è­‰é€šé â†’ å•Ÿå‹•ç™»å…¥å‹•ç•«
      startLoginAnimation(serial);
    } else {
      // 2. åºè™Ÿä¸åœ¨é›²ç«¯ï¼ˆå¯èƒ½è¢«ç®¡ç†å“¡åˆªé™¤ï¼‰â†’ æª¢æŸ¥ç”¨æˆ¶æœ¬åœ°ç´€éŒ„
      var userRecord = getUserSerialRecord(serial);
      if (userRecord) {
        if (userRecord.expiresAt && now > userRecord.expiresAt) {
          showLoginError(errorEl, 'âš  æ­¤åºè™Ÿå·²éæœŸï¼ï¼ˆæœ‰æ•ˆæœŸï¼š' + (userRecord.durationLabel || 'æœªçŸ¥') + 'ï¼‰');
          removeUserSerialRecord(serial);
          return;
        }
        // æœªéæœŸ â†’ å…è¨±ç™»å…¥
        startLoginAnimation(serial);
      } else {
        // 3. å®Œå…¨æ‰¾ä¸åˆ° â†’ æ‹’çµ•ç™»å…¥
        showLoginError(errorEl, 'âš  æ­¤åºè™Ÿæœªè¢«æˆæ¬Šæˆ–å·²è¢«æ’¤éŠ·');
      }
    }
  });
}

// ============ ç”¨æˆ¶æœ¬åœ°åºè™Ÿç´€éŒ„ï¼ˆå³ä½¿ç®¡ç†å“¡åˆªé™¤åºè™Ÿï¼ŒæœŸé™æœªåˆ°ä»å¯ç™»å…¥ï¼‰============
function getUserSerialRecords() {
  try {
    return JSON.parse(localStorage.getItem('rooms_user_serial_records') || '{}');
  } catch(e) { return {}; }
}

function saveUserSerialRecord(serial, expiresAt, durationLabel) {
  var clean = serial.replace(/-/g, '').toUpperCase().trim();
  var records = getUserSerialRecords();
  records[clean] = {
    expiresAt: expiresAt,
    durationLabel: durationLabel || 'æœªçŸ¥',
    savedAt: Date.now()
  };
  localStorage.setItem('rooms_user_serial_records', JSON.stringify(records));
}

function getUserSerialRecord(serial) {
  var clean = serial.replace(/-/g, '').toUpperCase().trim();
  var records = getUserSerialRecords();
  return records[clean] || null;
}

function removeUserSerialRecord(serial) {
  var clean = serial.replace(/-/g, '').toUpperCase().trim();
  var records = getUserSerialRecords();
  delete records[clean];
  localStorage.setItem('rooms_user_serial_records', JSON.stringify(records));
}

// ============ æ¯5åˆ†é˜è‡ªå‹•åˆ·æ–° ============
var AUTO_REFRESH_INTERVAL = 5 * 60; // 5åˆ†é˜ = 300ç§’
var refreshTimer = null;
var refreshElapsed = 0;
var autoRefreshCount = 0; // è¨˜éŒ„å·²è‡ªå‹•æ›´æ–°å¹¾æ¬¡

function formatCountdown(seconds) {
  var m = Math.floor(seconds / 60);
  var s = seconds % 60;
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function showRefreshNotify() {
  var notify = document.getElementById('refreshNotify');
  autoRefreshCount++;
  var now = new Date();
  var timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0') + ':' + 
                now.getSeconds().toString().padStart(2, '0');
  notify.textContent = 'âœ… çˆ†åˆ†ç‡æ•¸æ“šå·²è‡ªå‹•æ›´æ–°ï¼(' + timeStr + ')';
  notify.classList.add('show');
  setTimeout(function() { notify.classList.remove('show'); }, 3500);
}

function startAutoRefresh() {
  refreshElapsed = 0;
  var bar = document.getElementById('autoRefreshBar');
  var countdown = document.getElementById('refreshCountdown');
  var countdownText = document.getElementById('countdownText');

  // é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚å™¨
  countdown.style.display = 'flex';
  countdownText.textContent = formatCountdown(AUTO_REFRESH_INTERVAL);

  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(function() {
    refreshElapsed++;
    var remaining = AUTO_REFRESH_INTERVAL - refreshElapsed;
    var pct = (refreshElapsed / AUTO_REFRESH_INTERVAL) * 100;
    bar.style.width = pct + '%';

    // æ›´æ–°å€’æ•¸æ–‡å­—
    countdownText.textContent = formatCountdown(remaining);

    // æœ€å¾Œ30ç§’è®Šè‰²æé†’
    if (remaining <= 30) {
      countdown.style.borderColor = 'rgba(250,204,21,0.6)';
      countdown.style.color = '#facc15';
    } else {
      countdown.style.borderColor = 'rgba(34,211,238,0.4)';
      countdown.style.color = '#22d3ee';
    }

    // æ™‚é–“åˆ° â†’ è‡ªå‹•åˆ·æ–°
    if (refreshElapsed >= AUTO_REFRESH_INTERVAL) {
      refreshAllData();
      showRefreshNotify();
      refreshElapsed = 0;
      bar.style.width = '0%';
      countdownText.textContent = formatCountdown(AUTO_REFRESH_INTERVAL);
    }
  }, 1000);
}

// æ‰‹å‹•æ›´æ–°ä¹Ÿè¦é‡ç½®å€’æ•¸
function resetAutoRefreshTimer() {
  if (refreshTimer) {
    refreshElapsed = 0;
    var bar = document.getElementById('autoRefreshBar');
    bar.style.width = '0%';
    var countdownText = document.getElementById('countdownText');
    if (countdownText) countdownText.textContent = formatCountdown(AUTO_REFRESH_INTERVAL);
  }
}

// ============ ç™»å‡º ============
function handleLogout() {
  // æ¸…é™¤ç™»å…¥ç‹€æ…‹
  sessionStorage.removeItem('rooms_loggedIn');
  // åœæ­¢è‡ªå‹•åˆ·æ–°
  if (refreshTimer) {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }
  // éš±è—ç›¸é—œ UI å…ƒç´ 
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('refreshCountdown').style.display = 'none';
  document.getElementById('autoRefreshBar').style.width = '0%';
  // é¡¯ç¤ºç™»å…¥é®ç½©
  document.getElementById('loginOverlay').classList.remove('hidden');
  // æ¸…é™¤è¼¸å…¥æ¬„ä½
  document.getElementById('serialInput').value = '';
  document.getElementById('serialError').style.display = 'none';
  // å›åˆ°é é¢é ‚éƒ¨
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============ åˆå§‹åŒ– ============
window.addEventListener('DOMContentLoaded', function() {
  generateAllRooms();
  updateStats();
  renderCards(1);
  renderPagination();

  // åºè™Ÿæ¬„ä½æŒ‰ Enter éµç™»å…¥
  document.getElementById('serialInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleSerialLogin();
  });

  // åºè™Ÿè¼¸å…¥è‡ªå‹•æ ¼å¼åŒ–ï¼ˆè‡ªå‹•åŠ ç ´æŠ˜è™Ÿï¼‰
  document.getElementById('serialInput').addEventListener('input', function(e) {
    var val = this.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
    if (val.length > 12) val = val.substring(0, 12);
    var formatted = '';
    for (var i = 0; i < val.length; i++) {
      if (i > 0 && i % 4 === 0) formatted += '-';
      formatted += val[i];
    }
    this.value = formatted;
  });

  // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼ˆsession æ¢å¾©ï¼‰
  if (sessionStorage.getItem('rooms_loggedIn') === 'true') {
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('logoutBtn').style.display = 'block';
    startAutoRefresh();
  }
  // å¦‚æœ localStorage æœ‰å·²é©—è­‰çš„åºè™Ÿï¼Œè‡ªå‹•å¡«å…¥
  var savedSerial = localStorage.getItem('rooms_serial');
  if (savedSerial) {
    document.getElementById('serialInput').value = savedSerial;
  }
});
</script>

</body>
</html>